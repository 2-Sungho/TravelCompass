<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="placeMapper">
	
	<resultMap type="Place" id="place_rm">
		<id property="placeScrapNo" column="PLACE_SCRAP_NO"/>
		<result property="contentid" column="CONTENT_ID"/>
		<result property="contenttypeid" column="CONTENT_TYPE_ID"/>
		<result property="title" column="PLACE_TITLE"/>		
		<result property="firstimage" column="FIRST_IMAGE"/>
		<result property="addr1" column="PLACE_ADDR"/>
		<result property="mapx" column="MAPX"/>
		<result property="mapy" column="MAPY"/>
		
		<result property="scrapDate" column="SCRAP_DATE"/>
		<result property="reviewCount" column="REVIEW_COUNT"/>
		<result property="averageRating" column="AVERAGE_RATING"/>
	</resultMap>

	<resultMap type="Travel" id="travel">
		<id property="travelNo" column="TRAVEL_NO"/>
	</resultMap>

	<select id="scrapCheck" resultType="_int" >
		SELECT COUNT(*) FROM PLACE_SCRAP
		WHERE CONTENT_ID=#{contentid}
		AND MEMBER_NO=#{memberNo}
	</select>

	<insert id="scrap">
		INSERT INTO PLACE_SCRAP
		VALUES (SEQ_PLACE_SCRAP_NO.NEXTVAL, #{title} ,DEFAULT, #{firstimage}, #{mapx}, #{mapy}, #{contentid}, #{memberNo}, #{addr1}, #{contenttypeid})
	</insert>
	
	<delete id="scrapCancel">
		DELETE FROM PLACE_SCRAP
		WHERE MEMBER_NO=#{memberNo}
		AND CONTENT_ID=#{contentid}
	</delete>
	
	<!-- 스크랩한 장소 목록 조회 -->
	<select id="selectScrapPlaceList" resultMap="place_rm" parameterType="_int">
		SELECT PLACE_SCRAP_NO, PLACE_TITLE, FIRST_IMAGE, MAPX, MAPY, CONTENT_ID, PLACE_ADDR, CONTENT_TYPE_ID,
			TO_CHAR(SCRAP_DATE, 'YYYY"년" MM"월" DD"일"') SCRAP_DATE,
			(SELECT COUNT(*) FROM REVIEW R WHERE R.CONTENT_ID = PS.CONTENT_ID) REVIEW_COUNT,
			(SELECT NVL(AVG(RATING), 0)  FROM REVIEW R WHERE R.CONTENT_ID = PS.CONTENT_ID) AVERAGE_RATING
		FROM PLACE_SCRAP PS
		WHERE MEMBER_NO = #{memberNo}
	</select>
	
	
	<!-- 여행의 장소 목록 조회 -->
	<select id="selectTravelPlaceList">
		SELECT PLACE_SCRAP_NO, TRAVEL_LIST_NO, TRAVEL_LIST_ORDER, PLACE_TITLE, SCRAP_DATE, FIRST_IMAGE,
			MAPX, MAPY, CONTENT_ID, CONTENT_TYPE_ID, PLACE_ADDR,
			(SELECT COUNT(*) FROM REVIEW R WHERE R.CONTENT_ID = PS.CONTENT_ID) REVIEW_COUNT,
			(SELECT NVL(AVG(RATING), 0)  FROM REVIEW R WHERE R.CONTENT_ID = PS.CONTENT_ID) AVERAGE_RATING
		FROM TRAVEL_LIST TL
		JOIN PLACE_SCRAP PS USING (PLACE_SCRAP_NO) 
		WHERE TRAVEL_NO = #{travelNo}
	</select>
</mapper>
